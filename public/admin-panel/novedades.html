<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestor de Novedades - Flores Jrs</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body { background-color: #f0f2f5; }
    .header { background-color: #002f6c; color: white; padding: 1rem; display: flex; align-items: center; justify-content: space-between; }
    .header h1 { font-size: 1.5rem; margin: 0; }
    .container { max-width: 900px; margin: 2rem auto; }
    .card-title { font-weight: bold; color: #004aad; }
    .form-section { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
    .table-wrapper { margin-top: 2rem; }
    .table img { max-height: 60px; }
    .modal-title { font-weight: bold; }
  </style>
</head>
<body>
  <div class="header">
    <h1>üì¢ Novedades - Flores Jrs</h1>
    <button class="btn btn-outline-light" onclick="logout()">Cerrar sesi√≥n</button>
  </div>
  <div class="container">
    <div class="form-section">
      <h4 class="card-title mb-3">Publicar nueva novedad</h4>
      <form id="formNovedad" enctype="multipart/form-data">
        <div class="mb-3">
          <label class="form-label">T√≠tulo</label>
          <input type="text" class="form-control" id="titulo" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Texto</label>
          <textarea class="form-control" id="texto" rows="3" required></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Imagen (opcional)</label>
          <input type="file" class="form-control" id="imagen" accept="image/*">
        </div>
        <div class="mb-3">
          <label class="form-label">Destino</label>
          <select class="form-select" id="destino">
            <option value="todos">Todos los socios</option>
            <option value="categoria">Solo por categor√≠a</option>
            <option value="categoria_anio">Categor√≠a + A√±o</option>
          </select>
        </div>
        <div class="mb-3" id="categoriaContainer" style="display: none;">
          <label class="form-label">Categor√≠a</label>
          <select class="form-select" id="categoria"></select>
        </div>
        <div class="mb-3" id="anioContainer" style="display: none;">
          <label class="form-label">A√±o de nacimiento</label>
          <input type="number" class="form-control" id="anio_nacimiento">
        </div>
        <button type="submit" class="btn btn-primary">Publicar</button>
      </form>
    </div>

    <div class="table-wrapper">
      <h4 class="card-title mb-3">Novedades publicadas</h4>
      <table class="table table-hover bg-white rounded shadow">
        <thead class="table-light">
          <tr>
            <th>Imagen</th>
            <th>T√≠tulo</th>
            <th>Texto</th>
            <th>Fecha</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tablaNovedades"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal de Edici√≥n -->
  <div class="modal fade" id="modalEditar" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Editar novedad</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="edit_id">
          <div class="mb-3">
            <label class="form-label">T√≠tulo</label>
            <input type="text" class="form-control" id="edit_titulo">
          </div>
          <div class="mb-3">
            <label class="form-label">Texto</label>
            <textarea class="form-control" id="edit_texto"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="guardarCambios()">Guardar cambios</button>
        </div>
      </div>
    </div>
  </div>

<script>
const token = localStorage.getItem('token');
if (!token) location.href = 'login.html';
function logout() {
  localStorage.removeItem('token');
  location.href = 'login.html';
}
function fetchConToken(url, opciones = {}) {
  return fetch(url, {
    ...opciones,
    headers: { 'Authorization': 'Bearer ' + token, ...opciones.headers },
  });
}
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('destino').addEventListener('change', e => {
    document.getElementById('categoriaContainer').style.display = e.target.value !== 'todos' ? 'block' : 'none';
    document.getElementById('anioContainer').style.display = e.target.value === 'categoria_anio' ? 'block' : 'none';
  });

  document.getElementById('formNovedad').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData();
    formData.append('titulo', document.getElementById('titulo').value);
    formData.append('texto', document.getElementById('texto').value);
    formData.append('destino', document.getElementById('destino').value);
    if (document.getElementById('categoria').value)
      formData.append('categoria', document.getElementById('categoria').value);
    if (document.getElementById('anio_nacimiento').value)
      formData.append('anio_nacimiento', document.getElementById('anio_nacimiento').value);
    if (document.getElementById('imagen').files[0])
      formData.append('imagen', document.getElementById('imagen').files[0]);

    const res = await fetchConToken('/novedades', { method: 'POST', body: formData });
    const data = await res.json();
    if (!res.ok) return alert(data.error);
    alert('‚úÖ Publicada');
    document.getElementById('formNovedad').reset();
    cargar();
  });

  cargar();
});

async function cargar() {
  const res = await fetchConToken('/novedades');
  const novedades = await res.json();
  const tabla = document.getElementById('tablaNovedades');
  tabla.innerHTML = '';
  novedades.forEach(n => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${n.imagen_url ? `<img src="${n.imagen_url}">` : '‚Äî'}</td>
      <td>${n.titulo}</td>
      <td>${n.texto}</td>
      <td>${new Date(n.fecha).toLocaleDateString()}</td>
      <td>
        <button class="btn btn-sm btn-warning me-1" onclick="editar(${n.id}, '${n.titulo}', '${n.texto.replace(/'/g, '\\'')}')">‚úèÔ∏è</button>
        <button class="btn btn-sm btn-danger" onclick="eliminar(${n.id})">üóëÔ∏è</button>
      </td>`;
    tabla.appendChild(tr);
  });
}

function editar(id, titulo, texto) {
  document.getElementById('edit_id').value = id;
  document.getElementById('edit_titulo').value = titulo;
  document.getElementById('edit_texto').value = texto;
  new bootstrap.Modal(document.getElementById('modalEditar')).show();
}

async function guardarCambios() {
  const id = document.getElementById('edit_id').value;
  const titulo = document.getElementById('edit_titulo').value;
  const texto = document.getElementById('edit_texto').value;
  const res = await fetchConToken('/novedades/' + id, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ titulo, texto })
  });
  const data = await res.json();
  if (!res.ok) return alert(data.error);
  bootstrap.Modal.getInstance(document.getElementById('modalEditar')).hide();
  cargar();
}

async function eliminar(id) {
  if (!confirm('¬øEliminar esta novedad?')) return;
  const res = await fetchConToken('/novedades/' + id, { method: 'DELETE' });
  const data = await res.json();
  if (!res.ok) return alert(data.error);
  cargar();
}
</script>
</body>
</html>

