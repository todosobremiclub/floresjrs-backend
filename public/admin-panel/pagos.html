<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gesti√≥n de Pagos - Flores Jrs</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body { background-color: #004aad; color: white; margin: 0; }
    .sidebar { width: 200px; background-color: #002f6c; height: 100vh; position: fixed; top: 0; left: 0; padding: 1rem; display: flex; flex-direction: column; gap: 1.5rem; z-index: 1040; transition: transform 0.3s ease; }
    .sidebar h4 { color: white; }
    .sidebar button, .sidebar a { text-align: left; width: 100%; }
    .main-content { margin-left: 200px; padding: 2rem; transition: margin-left 0.3s ease; }
    .table td, .table th { vertical-align: middle; }
    .tabla-pagos td, .tabla-pagos th { font-size: 0.85rem; padding: 0.3rem 0.5rem; vertical-align: middle; white-space: nowrap; }
    .btn-yellow { background-color: #ffd500; color: black; font-weight: bold; font-size: 0.9rem; padding: 6px 12px; line-height: 1; }
    .btn-eliminar { background: none; border: none; color: #007bff; font-size: 1.1rem; padding: 4px; cursor: pointer; }
    h2.text-warning { font-size: 1.4rem; }
    .logo { height: 50px; }
    .toggle-btn { background: none; border: none; color: white; font-size: 1.5rem; position: fixed; top: 10px; left: 10px; z-index: 1050; display: none; }
    @media (max-width: 767px) {
      .sidebar { transform: translateX(-100%); }
      .sidebar.show { transform: translateX(0); }
      .toggle-btn { display: block; }
      .main-content { margin-left: 0 !important; padding: 1rem; }
      .tabla-pagos td, .tabla-pagos th { font-size: 0.78rem; padding: 0.25rem 0.4rem; }
      .btn-eliminar { font-size: 1rem; }
    }
  </style>
</head>
<body>
  <button class="toggle-btn" onclick="toggleSidebar()">‚ò∞</button>
  <div class="sidebar" id="sidebar">
    <h4>Men√∫</h4>
    <a href="/admin-panel/index.html" class="btn btn-outline-light">üè† Home</a>
    <a href="/admin-panel/pagos.html" class="btn btn-outline-light">üí∞ Pagos</a>
    <a href="/admin-panel/novedades.html" class="btn btn-outline-light">üì¢ Novedades</a>
    <a href="#" class="btn btn-outline-light">üîî Notificaciones</a>
    <a href="/admin-panel/configuracion.html" class="btn btn-outline-light">‚öôÔ∏è Configuraci√≥n</a>
    <button class="btn btn-outline-light mt-auto" onclick="logout()">Cerrar sesi√≥n</button>
  </div>

  <div class="main-content">
    <div class="text-center mb-4 mt-2 mt-md-0">
      <img src="flores_jrs_logo.png" alt="Escudo" class="logo mb-2" />
      <h2 class="text-warning m-0">Gesti√≥n de Pagos</h2>
    </div>

    <div class="d-flex justify-content-between mb-3">
      <button class="btn btn-success" id="btnNuevoPago">+ Registrar Pago</button>
    </div>

    <div class="mb-3">
      <input type="text" id="buscadorPagos" class="form-control" placeholder="Buscar por apellido o DNI" />
    </div>

    <table class="table table-bordered tabla-pagos text-white bg-white text-dark">
      <thead class="table-primary">
        <tr>
          <th>N¬∞ Socio</th>
          <th>Nombre</th>
          <th>Fecha de Pago</th>
          <th>Monto</th>
          <th>Acci√≥n</th>
        </tr>
      </thead>
      <tbody id="tablaPagos"></tbody>
    </table>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="modalNuevoPago" tabindex="-1">
    <div class="modal-dialog">
      <form class="modal-content" id="formPago">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Registrar Pago</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-black">
          <div class="mb-3">
            <label for="buscadorSocio" class="form-label">Buscar socio por Apellido</label>
            <input class="form-control" list="listaSocios" id="buscadorSocio" required />
            <datalist id="listaSocios"></datalist>
          </div>

          <div class="mb-3">
            <label for="fecha_pago" class="form-label">Fecha de Pago</label>
            <input type="date" id="fecha_pago" class="form-control" required />
          </div>

          <!-- Selector de Meses -->
          <div id="selector-anio-meses" class="text-center my-3">
            <div class="d-flex justify-content-center align-items-center mb-2">
              <button type="button" class="btn btn-sm btn-light me-2" onclick="cambiarAnio(-1)">‚Äπ</button>
              <h5 id="anioSeleccionado" class="m-0">2025</h5>
              <button type="button" class="btn btn-sm btn-light ms-2" onclick="cambiarAnio(1)">‚Ä∫</button>
            </div>
            <div class="row row-cols-4 g-2"></div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-success" type="submit">Guardar Pago</button>
        </div>
      </form>
    </div>
  </div>

  <style>
    .mes-cuadro {
      padding: 10px;
      background-color: #e0e0e0;
      border-radius: 5px;
      cursor: pointer;
      user-select: none;
      text-align: center;
      font-weight: bold;
      color: #004aad;
    }
    .mes-cuadro.seleccionado {
      background-color: #004aad;
      color: white;
    }
  </style>

  <script>
  let anioActual = new Date().getFullYear();
  let mesesSeleccionados = new Set();

  const nombresMeses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];

  function renderizarMeses() {
    const contenedor = document.querySelector('#selector-anio-meses .row');
    contenedor.innerHTML = '';

    nombresMeses.forEach((mes, i) => {
      const idMes = `${anioActual}-${(i + 1).toString().padStart(2, '0')}`;
      const div = document.createElement('div');
      div.className = 'col';
      div.innerHTML = `
        <div class="mes-cuadro ${mesesSeleccionados.has(idMes) ? 'seleccionado' : ''}" onclick="toggleMes('${idMes}')">
          ${mes}
        </div>
      `;
      contenedor.appendChild(div);
    });

    document.getElementById('anioSeleccionado').textContent = anioActual;
  }

  function cambiarAnio(direccion) {
    anioActual += direccion;
    renderizarMeses();
  }

  function toggleMes(idMes) {
    if (mesesSeleccionados.has(idMes)) {
      mesesSeleccionados.delete(idMes);
    } else {
      mesesSeleccionados.add(idMes);
    }
    renderizarMeses();
  }

  function obtenerMesesPagados() {
    return Array.from(mesesSeleccionados);
  }

  document.addEventListener('DOMContentLoaded', () => {
    renderizarMeses();

    const btnGuardarMeses = document.getElementById('btnGuardarMeses');
    const inputBusqueda = document.getElementById('buscadorSocio');
    const listaSocios = document.getElementById('listaSocios');
    const modal = new bootstrap.Modal(document.getElementById('modalNuevoPago'));
    const formPago = document.getElementById('formPago');
    const inputFecha = document.getElementById('fecha_pago');
    const tablaPagos = document.getElementById('tablaPagos');
    const btnNuevoPago = document.getElementById('btnNuevoPago');

    btnNuevoPago.addEventListener('click', async () => {
      listaSocios.innerHTML = '';
      inputBusqueda.value = '';
      try {
        const res = await fetch('/socio', {
          headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
        });
        const socios = await res.json();
        socios.forEach(s => {
          const opt = document.createElement('option');
          opt.value = `${s.numero} - ${s.nombre} ${s.apellido}`;
          opt.dataset.numero = s.numero;
          listaSocios.appendChild(opt);
        });
      } catch {
        alert('‚ùå Error al cargar socios');	
      }
      inputFecha.valueAsDate = new Date();
      modal.show();
    });

    btnGuardarMeses.addEventListener('click', async () => {
      	options].find(opt => opt.value === inputBusqueda.value);
      if (!opcion) {
        alert('‚ùå Socio inv√°lido');
        return;
      }
      const numeroSocio = parseInt(opcion.dataset.numero);
      const meses = obtenerMesesPagados();
      if (meses.length === 0) {
        alert('‚ö†Ô∏è Seleccion√° al menos un mes a registrar');
        return;
      }
      try {
        const res = await fetch('/pagos/mensuales', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          },
          body: JSON.stringify({ numeroSocio, meses })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Error al registrar meses');
        alert('‚úÖ Meses registrados correctamente');
        modal.hide();
        cargarPagos();
      } catch (err) {
        console.error('‚ùå', err);
        alert('Error al guardar meses');
      }
    });

    formPago.addEventListener('submit', async (e) => {
  e.preventDefault();

  const opcion = [...listaSocios.options].find(opt => opt.value === inputBusqueda.value);
  if (!opcion) return alert('‚ùå Socio inv√°lido');

  const numeroSocio = parseInt(opcion.dataset.numero);
  const meses = obtenerMesesPagados();

  if (meses.length === 0) {
    alert('‚ö†Ô∏è Seleccion√° al menos un mes a registrar');
    return;
  }

  try {
    const res = await fetch('/pagos/mensuales', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + localStorage.getItem('token')
      },
      body: JSON.stringify({ numeroSocio, meses })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Error al registrar meses');

    alert('‚úÖ Pago registrado correctamente');
    modal.hide();
    cargarPagos();
  } catch (err) {
    console.error('‚ùå', err);
    alert(err.message || '‚ùå Error al registrar el pago');
  }
});


    async function cargarPagos() {
      try {
        const res = await fetch('/pagos', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          }
        });
        const pagos = await res.json();
        tablaPagos.innerHTML = '';
        pagos.forEach(p => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${p.socio_id}</td>
            <td>${p.nombre}</td>
            <td>${p.fecha_pago}</td>
            <td>$${parseFloat(p.monto).toFixed(2)}</td>
            <td>
              <button class="btn-eliminar" data-id="${p.id}" title="Eliminar">üóëÔ∏è</button>
            </td>
          `;
          tablaPagos.appendChild(row);
        });
      } catch {
        alert('‚ùå Error al cargar pagos');
      }
    }

    document.body.addEventListener('click', async (e) => {
      if (e.target.classList.contains('btn-eliminar')) {
        const id = e.target.dataset.id;
        if (confirm('¬øEst√°s seguro que quer√©s eliminar este pago?')) {
          try {
            const res = await fetch(`/pagos/${id}`, {
              method: 'DELETE',
              headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
              }
            });
            if (!res.ok) throw new Error();
            alert('‚úÖ Pago eliminado');
            cargarPagos();
          } catch {
            alert('‚ùå Error al eliminar el pago');
          }
        }
      }
    });

    cargarPagos();
  });
</script>
</body>
</html>




