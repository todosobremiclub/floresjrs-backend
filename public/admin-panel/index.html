<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gesti√≥n de Socios - Flores Jrs</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      background-color: #004aad;
      color: white;
      margin: 0;
    }
    .sidebar {
      width: 200px;
      background-color: #002f6c;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    .sidebar h4 {
      color: white;
    }
    .sidebar button,
    .sidebar a {
      text-align: left;
      width: 100%;
    }
    .main-content {
      margin-left: 200px;
      padding: 2rem;
    }
    .table td, .table th {
      vertical-align: middle;
    }
    .btn-yellow {
      background-color: #ffd500;
      color: black;
      font-weight: bold;
      font-size: 0.9rem;
      padding: 6px 12px;
      line-height: 1;
    }
    .logo {
      height: 50px;
    }
    h2.text-warning {
      font-size: 1.4rem;
    }
    #buscador {
      height: 36px;
      font-size: 0.9rem;
      padding: 0.25rem 0.75rem;
    }
    #btnAbrirFormulario {
      height: 36px;
      font-size: 0.9rem;
      padding: 0 12px;
    }
  </style>
</head>
<body>
  <!-- Men√∫ lateral -->
  <div class="sidebar">
    <h4>Men√∫</h4>
    <a href="index.html" class="btn btn-outline-light">üè† Home</a>
    <a href="pagos.html" class="btn btn-outline-light">üí∞ Pagos</a>
    <a href="#" class="btn btn-outline-light">üì¢ Novedades</a>
    <a href="#" class="btn btn-outline-light">üîî Notificaciones</a>
    <button class="btn btn-outline-light mt-auto" onclick="logout()">Cerrar sesi√≥n</button>
  </div>

  <!-- Contenido principal -->
  <div class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div class="d-flex align-items-center">
        <img src="flores_jrs_logo.png" alt="Escudo" class="logo me-3" />
        <h2 class="text-warning m-0">Gesti√≥n de Socios</h2>
      </div>
    </div>

    <div class="d-flex mb-3">
      <input type="text" id="buscador" class="form-control me-2" placeholder="Buscar por nombre, apellido o DNI" />
      <button class="btn btn-yellow" id="btnAbrirFormulario">Generar nuevo socio</button>
    </div>

    <div class="table-responsive">
      <table class="table table-striped table-bordered text-center bg-white">
        <thead class="table-primary">
          <tr>
            <th style="cursor:pointer" data-sort="numero">N¬∫ Socio</th>
            <th style="cursor:pointer" data-sort="dni">DNI</th>
            <th>Nombre</th>
            <th style="cursor:pointer" data-sort="apellido">Apellido</th>
            <th style="cursor:pointer" data-sort="categoria">Categor√≠a</th>
            <th>Tel√©fono</th>
            <th>Fecha de Nacimiento</th>
            <th style="cursor:pointer" data-sort="nacimiento">A√±o Nacimiento</th>
            <th>Fecha de Ingreso</th>
            <th>Activo</th>
            <th>Becado</th>
            <th>Foto</th>
            <th>Opciones</th>
          </tr>
        </thead>
        <tbody id="tablaSocios"></tbody>
      </table>
    </div>
  </div>

<!-- CONTIN√öA DESDE LA PRIMERA PARTE -->

<!-- Modal Nuevo Socio -->
<div class="modal fade" id="modalNuevoSocio" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="formNuevoSocio">
      <div class="modal-header">
        <h5 class="modal-title">Socio</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input class="form-control mb-2" placeholder="N√∫mero de socio" id="numero_socio" required />
        <input class="form-control mb-2" placeholder="DNI" id="dni" required />
        <input class="form-control mb-2" placeholder="Nombre" id="nombre" required />
        <input class="form-control mb-2" placeholder="Apellido" id="apellido" required />
        <input class="form-control mb-2" placeholder="Subcategor√≠a" id="subcategoria" />
        <input class="form-control mb-2" placeholder="Tel√©fono" id="telefono" />
        <div class="mb-2">
          <label for="fecha_nacimiento" class="form-label text-dark">Fecha de Nacimiento</label>
          <input class="form-control" type="date" id="fecha_nacimiento" required />
        </div>
        <div class="mb-2">
          <label for="fecha_ingreso" class="form-label text-dark">Fecha de Ingreso</label>
          <input class="form-control" type="date" id="fecha_ingreso" required />
        </div>
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" id="activo" />
          <label class="form-check-label text-dark" for="activo">Activo</label>
        </div>
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" id="becado" />
          <label class="form-check-label text-dark" for="becado">Becado</label>
        </div>
        <input class="form-control mb-2" type="file" id="foto" accept="image/*" />
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-yellow">Guardar</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- Scripts -->
<script>
  const token = localStorage.getItem('token');
  if (!token) window.location.href = '/admin-panel/login.html';

  function fetchConToken(url, opciones = {}) {
    opciones.headers = opciones.headers || {};
    opciones.headers['Authorization'] = `Bearer ${token}`;
    return fetch(url, opciones);
  }

  function logout() {
    localStorage.removeItem('token');
    window.location.href = '/admin-panel/login.html';
  }

async function cargarSocios() {
  try {
    const res = await fetchConToken('/socio');
    if (!res.ok) throw new Error('Error al obtener socios');
    const socios = await res.json();
    const tabla = document.getElementById('tablaSocios');
    const buscador = document.getElementById('buscador');

    let ordenActual = { campo: null, asc: true };

    function ordenarSocios(lista, campo) {
      const asc = (ordenActual.campo === campo) ? !ordenActual.asc : true;
      ordenActual = { campo, asc };

      return lista.sort((a, b) => {
        let valA = (a[campo] ?? '').toString().toLowerCase();
        let valB = (b[campo] ?? '').toString().toLowerCase();

        if (!isNaN(valA) && !isNaN(valB)) {
          valA = parseFloat(valA);
          valB = parseFloat(valB);
        }

        return asc ? (valA > valB ? 1 : valA < valB ? -1 : 0) : (valA < valB ? 1 : valA > valB ? -1 : 0);
      });
    }

    function mostrarFiltrados(filtro = '') {
      tabla.innerHTML = '';
      let sociosFiltrados = socios.filter(s =>
        (`${s.nombre} ${s.apellido} ${s.dni}`.toLowerCase()).includes(filtro.toLowerCase())
      );

      if (ordenActual.campo) {
        sociosFiltrados = ordenarSocios(sociosFiltrados, ordenActual.campo);
      }

      sociosFiltrados.forEach(s => {
        const fila = document.createElement('tr');
        fila.innerHTML = `
          <td>${s.numero}</td>
          <td>${s.dni}</td>
          <td>${s.nombre}</td>
          <td>${s.apellido}</td>
          <td>${s.subcategoria ?? ''}</td>
          <td>${s.telefono ?? '‚Äî'}</td>
          <td>${s.nacimiento ?? ''}</td>
          <td>${s.nacimiento?.substring(0, 4) ?? ''}</td>
          <td>${s.fecha_ingreso ?? ''}</td>
          <td><input type="checkbox" class="check-activo" data-id="${s.numero}" ${s.activo ? 'checked' : ''} /></td>
          <td><input type="checkbox" class="check-becado" data-id="${s.numero}" ${s.becado ? 'checked' : ''} /></td>
          <td>${s.foto_url ? `<img src="${s.foto_url}" width="30" style="border-radius:4px"/>` : 'Sin foto'}</td>
          <td class="p-1">
            <div class="d-flex justify-content-center gap-1">
              <button class="btn btn-sm btn-outline-light btn-editar px-2 py-1" data-id="${s.numero}">‚úèÔ∏è</button>
              <button class="btn btn-sm btn-outline-warning btn-eliminar px-2 py-1" data-id="${s.numero}">üóëÔ∏è</button>
            </div>
          </td>
        `;
        tabla.appendChild(fila);
      });
    }

    mostrarFiltrados();
    buscador.addEventListener('input', e => mostrarFiltrados(e.target.value));
    document.querySelectorAll('th[data-sort]').forEach(th => {
      th.addEventListener('click', () => {
        const campo = th.dataset.sort;
        ordenActual.campo = campo;
        mostrarFiltrados(buscador.value);
      });
    });
  } catch (error) {
    alert('‚ùå Error al cargar socios: ' + error.message);
  }
}

  document.addEventListener('DOMContentLoaded', () => {
    // Aqu√≠ va todo tu c√≥digo JS de manejo de socios
    cargarSocios();
  });
</script>
</body>
</html>
